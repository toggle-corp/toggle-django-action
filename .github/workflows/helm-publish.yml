name: Helm Publish

on:
  workflow_call:
    inputs:
      push_docker_image:
        type: boolean
        description: "Push docker image to registry"
        default: true
      run_graphql_check:
        type: boolean
        description: "Run GraphQL schema validation step"
        default: true
      compose_file:
        type: string
        description: "Docker Compose file to use for running containers"
        default: "docker-compose.yml"
      service_name:
        type: string
        description: "Docker Compose service name for the Django application"
        default: "web"
      test_target:
        type: string
        description: "Test script path to run inside the container"
        required: true
      chart_directory:
        type: string
        description: "Path to the Helm chart directory"
        required: true
    outputs:
      helm_repo_url:
        description: "Helm repo URL"
        value: ${{ jobs.build.outputs.helm_repo_url }}
      helm_chart:
        description: "Helm Chart"
        value: ${{ jobs.build.outputs.helm_chart }}
      helm_target_revision:
        description: "Helm target revision"
        value: ${{ jobs.build.outputs.helm_target_revision }}
      docker_image:
        description: "Docker image"
        value: ${{ jobs.ci.outputs.docker_image }}

permissions:
  contents: read
  packages: write

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/django-docker-ci.yml
    with:
      push_docker_image: ${{ inputs.push_docker_image }}
      run_graphql_check: ${{ inputs.run_graphql_check }}
      compose_file: ${{ inputs.compose_file }}
      service_name: ${{ inputs.service_name }}
      chart_directory: ${{ inputs.chart_directory }}
      test_target: ${{inputs.test_target}}
    secrets: inherit

  build:
    name: Publish Helm
    needs: ci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.chart_directory }}

    outputs:
      helm_repo_url: ${{ steps.push.outputs.helm_repo_url }}
      helm_chart: ${{ steps.push.outputs.helm_chart }}
      helm_target_revision: ${{ steps.push.outputs.helm_target_revision }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: ðŸ³ Helm dependency
        run: |
          yq --indent 0 '.dependencies | map(select(.repository | test("^oci:") | not)) | map(["helm", "repo", "add", .name, .repository] | join(" ")) | .[]' Chart.lock | sh --
          helm dependency build .

      - name: Tag docker image in Helm Chart values.yaml
        env:
          IMAGE_NAME: ${{ needs.ci.outputs.docker_image_name }}
          IMAGE_TAG: ${{ needs.ci.outputs.docker_image_tag }}
        run: |
          sed -i "s|SET-BY-CICD-IMAGE|$IMAGE_NAME|" values.yaml
          sed -i "s/SET-BY-CICD-TAG/$IMAGE_TAG/" values.yaml

      - name: Package Helm Chart
        env:
          IMAGE_TAG: ${{ needs.ci.outputs.docker_image_tag }}
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="-$(echo $GITHUB_SHA | head -c7)"
            sed -i "s/-SET-BY-CICD/$TAG/g" Chart.yaml
          else
            if [[ "$GITHUB_REF_NAME" == *"/"* ]]; then
              sed -i 's/^\(name:.*\)-helm$/\1-dev-helm/' Chart.yaml
            fi
            sed -i "s/SET-BY-CICD/$IMAGE_TAG/g" Chart.yaml
          fi
          mkdir -p .helm-charts
          helm package . -d .helm-charts

      - name: Push Helm Chart
        id: push
        env:
          IMAGE: ${{ needs.ci.outputs.docker_image }}
          OCI_REPO: oci://ghcr.io/${{ github.repository_owner }}
        run: |
          OCI_REPO=$(echo $OCI_REPO | tr '[:upper:]' '[:lower:]')
          PACKAGE_FILE=$(ls .helm-charts/*.tgz | head -n 1)

          echo "# Helm Chart" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          helm push "$PACKAGE_FILE" $OCI_REPO 2>> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          HELM_CHART=$(helm show chart "$PACKAGE_FILE" | grep '^name:' | awk '{print $2}')
          HELM_TARGET_REVISION=$(helm show chart "$PACKAGE_FILE" | grep '^version:' | awk '{print $2}')

          echo "> [!Important]" >> $GITHUB_STEP_SUMMARY
          echo "> Helm Repo URL: **$OCI_REPO**" >> $GITHUB_STEP_SUMMARY
          echo "> Helm Chart: **$HELM_CHART**" >> $GITHUB_STEP_SUMMARY
          echo "> Helm Target Revision: **$HELM_TARGET_REVISION**" >> $GITHUB_STEP_SUMMARY
          echo "> Docker image: **$IMAGE**" >> $GITHUB_STEP_SUMMARY

          echo "::notice::Helm Repo URL: $OCI_REPO"
          echo "::notice::Helm Chart: $HELM_CHART"
          echo "::notice::Helm Target Revision: $HELM_TARGET_REVISION"

          echo "helm_repo_url=$OCI_REPO" >> $GITHUB_OUTPUT
          echo "helm_chart=$HELM_CHART" >> $GITHUB_OUTPUT
          echo "helm_target_revision=$HELM_TARGET_REVISION" >> $GITHUB_OUTPUT
